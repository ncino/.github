name: {{REPLACE_REPO_NAME}} 1GP CI build
on:
  push:
    branches:
      - release

  pull_request:
    branches:
      - release

  workflow_dispatch:
    inputs:
      CLEAN_ORG:
        description: 'CLEAN_ORG - Input "true" to spin up a fresh org instead of pulling from orgfarm'
        required: false
        type: boolean
        default: false
      PRESERVE_ORG:
        description: 'PRESERVE_ORG - Input "true" to preserve the org after the workflow completes. Auth Information is stored in the build artifacts.'
        required: false
        type: boolean
        default: false

  workflow_call:
    inputs:
      config-path:
        required: true
        type: string

concurrency:
    group: '${{ github.workflow }} @ ${{ github.event.pull_request.head.label || github.head_ref || github.ref }}'
    cancel-in-progress: true

permissions:
  id-token: write # This is required for requesting the ID token for AWS actions
  contents: read  # This is required for actions/checkout

env:
    BUILD_URL: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
    COMMIT_SHA1: "${{ github.sha }}"
    DD_AGENT_MAJOR_VERSION: "7"
    DD_API_KEY: "${{ REPLACE_DD_API_SECRET }}"
    DD_APP_KEY: "${{ REPLACE_DD_APP_SECRET }}"
    DD_SITE: "datadoghq.com"
    DEVOPS_SCRIPTS_PATH: "./devops-utility-belt/scripts"
    DX_DELETE_SCRATCH_ORG: true
    ENABLE_LINTING: "false"
    GIT_BASE_BRANCH: "${{ github.base_ref }}"
    GIT_BRANCH: "${{ github.ref_name }}"
    GITHUB_TOKEN: "${{REPLACE_TOKEN_SECRET}}"
    REPO_NAME: "${{ github.event.repository.name }}"

jobs:
    CI-build-and-test:
        runs-on: ubuntu-latest
        defaults:
          run:
              shell: bash
        steps:
        # ğŸ¬ Install Phase ğŸ¬
        - name: Create necessary directories
          run: mkdir /tmp/testResults/

        - name: ğŸ«¥ Checkout {{REPLACE_REPO_NAME}} ğŸ˜
          uses: actions/checkout@v3
          with:
            token: "${{REPLACE_TOKEN_SECRET}}"

        - name: ğŸ³ Get DevOps Scripts ğŸ³
          uses: actions/checkout@v3
          with:            
            token: "${{REPLACE_TOKEN_SECRET}}"
            repository: "ncino/devops-utility-belt"
            path: "devops-utility-belt"

        - name: ğŸ Setup Python ğŸ
          uses: actions/setup-python@v4
          with:
            python-version: '3.10'
            cache: 'pip'
            cache-dependency-path: |
              devops-utility-belt/Pipfile.lock

        - name: ğŸª„ Install python repos ğŸ§Œ
          run: $DEVOPS_SCRIPTS_PATH/install_python_repos.sh

        - name: ğŸ“‡ Configure .npmrc file ğŸ“œ
          run: $DEVOPS_SCRIPTS_PATH/npm_auth.sh

        - name: ğŸ£ Setup Node ğŸ‘Œ
          uses: actions/setup-node@v3
          with:
            node-version-file: '.nvmrc'
            cache: 'npm'

        - name: â˜ï¸ Install SFDX and authenticate â˜ï¸
          run: $DEVOPS_SCRIPTS_PATH/install_sfdx_and_auth.sh
          env:
            DEV_HUB_AUTH_URL: ${{REPLACE_DEV_HUB_SECRET}}

        - name: ğŸ‘©â€ğŸš€ Setup Log exports ğŸ‘©â€ğŸš€
          run: source $DEVOPS_SCRIPTS_PATH/sfdx_and_node_version_export.sh

        - name: ğŸ‘ Install Node Packages ğŸ‘
          run: npm ci --unsafe-perm

        # ğŸ¥©ğŸ¥” Build Phase ğŸ¥©ğŸ¥”
        - name: ğŸ‘©â€ğŸ”¬ Confirms proper xml syntax for files under config/ ğŸ‘¨â€ğŸ«
          run: |
            sudo apt-get update && sudo apt-get install libxml2-utils
            find config -name '*.xml' -print0 | xargs -0 -n1 -r xmllint --noout

        # Uncomment once tests have been applied
        # - name: ğŸ§‘â€ğŸ¤ Run npm test:unit script ğŸ‘©â€ğŸ¤
        #   run: npm run test:unit

        - name: ğŸ‘·â€â™€ï¸ Validate destructive changes ğŸ‘·â€â™€ï¸
          run: $DEVOPS_SCRIPTS_PATH/validate_destructive_changes.sh $COMMIT_SHA1

        - name: ğŸ‘©â€ğŸŒ¾ Get orgfarm org ğŸ‘¨â€ğŸŒ¾
          run: orgfarm-request -c "$REPO_NAME"
          env:
            ORG_FARM_API_KEY: "${{REPLACE_ORGFARM_KEY_SECRET}}"
            ORGFARM_API_URL: "${{REPLACE_ORGFARM_URL_SECRET}}"

        - name: ğŸ¤  Display Org ğŸ”
          run: $DEVOPS_SCRIPTS_PATH/display_org.sh

        - name: ğŸ—£ï¸ Run predependency script if org was created locally
          run: |
            if [[ -f /tmp/create_dx_local_check.txt ]] && [[ -f ./scripts/org_farm/pre_dependencies.sh ]]; then
                ./scripts/org_farm/pre_dependencies.sh
            fi

        - name: ğŸ“¦ Update SF package dependencies ğŸ“¦
          run: sfupdate

        - name: ğŸš¢ Deploy source ğŸš¢
          run: $DEVOPS_SCRIPTS_PATH/sfdx_source_push.sh

        - name: ğŸ’¼ Run sfencrypt if org created locally ğŸ’¼
          run: sfencrypt

        - name: ğŸ¤ Run Apex unit tests ğŸ¤
          run: sfdxunittests -s src -o /tmp/testResults/junit.xml

        # ğŸ§¹ Post-Build Cleanup Phase ğŸ§¹
        - name: ğŸ’€ Delete the dx scratch org ğŸ’€
          if: inputs.PRESERVE_ORG == false && always()
          run: $DEVOPS_SCRIPTS_PATH/delete_scratch_org.sh

        # ğŸ Artifact Upload Phase ğŸ
        - name: ğŸ§Ÿâ€â™€ï¸ Archive unit test artifacts ğŸ‘©â€ğŸš€
          uses: actions/upload-artifact@v3
          with:
            name: Unit Test Files
            path: /tmp/testResults/*

        - name: ğŸ“© Upload Scratch Org Authentication Information ğŸ“¨
          uses: actions/upload-artifact@v3
          with: 
            name: Scratch Org Authentication Information
            path: auth.key

        - name: ğŸ¤™ Upload Artifact and trigger packaging ğŸ„â€â™‚ï¸
          if: github.ref_name == 'release'
          uses: ncino/action-aws/s3_trigger_pipeline@v2

        - name: ğŸ‘ Success Message ğŸ‘
          run: cat $DEVOPS_SCRIPTS_PATH/config/deploy_message.txt
