name: nCino Salesforce 1GP CI build
on:
    push:
        branches:
            - release

    pull_request:
        branches:
            - release
            
    workflow_dispatch:
      inputs:
        CLEAN_ORG:
          description: 'CLEAN_ORG - Input "true" to spin up a fresh org instead of pulling from orgfarm'
          required: false
          type: choice
          default: "false"
          options:
            - true
            - false

    workflow_call:
        inputs:
            config-path:
                required: true
                type: string

concurrency:
    group: '${{ github.workflow }} @ ${{ github.event.pull_request.head.label || github.head_ref || github.ref }}'
    cancel-in-progress: true

env:
    BUILD_URL: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
    COMMIT_SHA1: "${{ github.sha }}"
    DD_AGENT_MAJOR_VERSION: "7"
    DD_API_KEY: "${{ secrets.DD_API_KEY }}"
    DD_APP_KEY: "${{ secrets.DD_APP_KEY }}"
    DD_SITE: "datadoghq.com"
    DEVOPS_SCRIPTS_PATH: "./ci-docker-images/images/ci-private-ubuntu/scripts"
    DX_DELETE_SCRATCH_ORG: true
    ENABLE_LINTING: "false"
    GIT_BASE_BRANCH: "${{ github.base_ref }}"
    GIT_BRANCH: "${{ github.ref_name }}"
    GITHUB_TOKEN: "${{ secrets.CI_USER_REPO_ACCESS_TOKEN }}"
    REPO_NAME: "${{ github.event.repository.name }}"

jobs:
    CI-build-and-test:
        runs-on: ubuntu-latest
        defaults:
          run:
              shell: bash
        steps:
        # ğŸ¬ Install Phase ğŸ¬
        - name: Create necessary directories
          run: mkdir /tmp/testResults/

        - name: Display Action's Environment Variables
          run: env

        - name: ğŸ«¥ Checkout force-matrix-manager ğŸ˜
          uses: actions/checkout@v3
          with:
            token: "${{ secrets.CI_USER_REPO_ACCESS_TOKEN }}"

        - name: ğŸ³ Get DevOps Scripts ğŸ³
          uses: actions/checkout@v3
          with:            
            token: "${{ secrets.CI_USER_REPO_ACCESS_TOKEN }}"
            repository: "ncino/ci-docker-images"
            path: "ci-docker-images"

        - name: ğŸ Setup Python ğŸ
          uses: actions/setup-python@v4
          with:
            python-version: '3.10'
            cache: 'pip'
            cache-dependency-path: |
              ci-docker-images/Pipfile.lock

        - name: ğŸª„ Install python repos ğŸ§Œ
          run: $DEVOPS_SCRIPTS_PATH/install_python_repos.sh

        - name: ğŸ£ Setup Node ğŸ‘Œ
          uses: actions/setup-node@v3
          with:
            node-version-file: '.nvmrc'
            cache: 'npm'

        - name: Setup Github config for npm
          run: |
            printf "//npm.pkg.github.com/:_authToken=${GITHUB_TOKEN} \n" >> .npmrc
            printf "@ncino:registry=https://npm.pkg.github.com/ncino" >> .npmrc
          env:
            GITHUB_TOKEN: "${{ secrets.CI_USER_REPO_ACCESS_TOKEN }}"

        - name: â˜ï¸ Install SFDX and authenticate â˜ï¸
          run: $DEVOPS_SCRIPTS_PATH/install_sfdx_and_auth.sh
          env:
            DEV_HUB_AUTH_URL: ${{ secrets.DEVOPS_DEV_HUB_AUTH_URL }}

        - name: ğŸ‘©â€ğŸš€ Setup Log exports ğŸ‘©â€ğŸš€
          run: source $DEVOPS_SCRIPTS_PATH/sfdx_and_node_version_export.sh

        - name: ğŸ‘ Install Node Packages ğŸ‘
          run: $DEVOPS_SCRIPTS_PATH/npm.sh ci --unsafe-perm

        # ğŸ¥©ğŸ¥” Build Phase ğŸ¥©ğŸ¥”
        - name: ğŸ‘©â€ğŸ”¬ Confirms proper xml syntax for files under config/ ğŸ‘¨â€ğŸ«
          run: |
            sudo apt-get update && sudo apt-get install libxml2-utils
            find config -name '*.xml' -print0 | xargs -0 -n1 -r xmllint --noout

        - name: ğŸ§‘â€ğŸ¤ Run npm test:unit script ğŸ‘©â€ğŸ¤
          run: $DEVOPS_SCRIPTS_PATH/npm.sh run test:unit

        - name: ğŸ‘·â€â™€ï¸ Validate destructive changes ğŸ‘·â€â™€ï¸
          run: $DEVOPS_SCRIPTS_PATH/validate_destructive_changes.sh $COMMIT_SHA1

        - name: ğŸ‘¨ğŸ¿â€ğŸŒ¾ Get orgfarm org ğŸ‘¨ğŸ¿â€ğŸŒ¾
          run: orgfarm-request -c "$REPO_NAME"
          env:
            ORG_FARM_API_KEY: "${{ secrets.ORG_FARM_API_KEY }}"
            ORGFARM_API_URL: "${{ vars.ORGFARM_API_URL }}"

        - name: ğŸ¤  Display Org ğŸ”
          run: $DEVOPS_SCRIPTS_PATH/display_org.sh

        - name: ğŸ—£ï¸ Run predependency script if org was created locally
          run: |
            if [[ -f /tmp/create_dx_local_check.txt ]] && [[ -f ./scripts/org_farm/pre_dependencies.sh ]]; then
                ./scripts/org_farm/pre_dependencies.sh
            fi

        - name: ğŸ“¦ Update SF package dependencies ğŸ“¦
          run: sfupdate

        - name: ğŸš¢ Deploy source ğŸš¢
          run: $DEVOPS_SCRIPTS_PATH/sfdx_source_push.sh

        - name: ğŸ’¼ Run sfencrypt if org created locally ğŸ’¼
          run: sfencrypt

        - name: ğŸ¤ Run Apex unit tests ğŸ¤
          run: sfdxunittests -s src -o /tmp/testResults/junit.xml

        # ğŸ§¹ Post-Build Cleanup Phase ğŸ§¹
        - name: ğŸ’€ Delete the dx scratch org ğŸ’€
          if: ${{ always() }}
          run: $DEVOPS_SCRIPTS_PATH/delete_scratch_org.sh

        # ğŸ Artifact Upload Phase ğŸ
        - name: ğŸ§Ÿâ€â™€ï¸ Archive unit test artifacts ğŸ‘©â€ğŸš€
          uses: actions/upload-artifact@v3
          with:
            name: Unit test files
            path: /tmp/testResults/*

        - name: ğŸ§â€â™‚ï¸ Archive NPM logs ğŸ§Ÿâ€â™‚ï¸
          uses: actions/upload-artifact@v3
          with:
            name: npm installation logs
            path: npm_ci.log

        - name: ğŸ¤™ Upload Artifact and trigger packaging ğŸ„â€â™‚ï¸
          if: github.ref_name == 'release'
          uses: ncino/github-aws-actions/s3_trigger_pipeline@v1
          with:
            awsAccessKeyId: ${{ secrets.TEST_AWS_ACCESS_KEY_GITHUB_CMITZEL }}
            awsSecretAccessKey: ${{ secrets.TEST_AWS_SECRET_ACCESS_KEY_GITHUB_CMITZEL }}

        - name: ğŸ‘ Success Message ğŸ‘
          run: cat $DEVOPS_SCRIPTS_PATH/config/deploy_message.txt
